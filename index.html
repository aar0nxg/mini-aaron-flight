<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Mini Flight ‚Äî Choose Your Journey</title>
<style>
  :root{ --bg-1:#0b0820; --bg-2:#160f32; --bg-3:#201443; --accent:#ff5a7a; --accent-2:#b084ff; }
  html,body{height:100%;margin:0;background:
    radial-gradient(1600px 100% at 50% 0%,rgba(255,255,255,.05),transparent),
    linear-gradient(180deg,var(--bg-1),var(--bg-2) 60%,var(--bg-3));
    color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  #gameRoot{position:relative;max-width:960px;margin:0 auto;height:100vh;overflow:hidden;
    box-shadow:0 8px 40px rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.07);border-radius:16px}
  canvas{display:block;width:100%;height:100%;outline:none}
  .hud{position:absolute;top:12px;left:12px;display:flex;gap:10px;z-index:5}
  .pill{background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.15);padding:8px 12px;border-radius:999px}
  .hud-right{position:absolute;top:12px;right:12px;display:flex;gap:10px;z-index:6}
  .btn{cursor:pointer;user-select:none}
  .bar{--p:0;position:relative;height:10px;width:240px;border-radius:999px;background:rgba(255,255,255,.15);overflow:hidden}
  .bar::after{content:"";position:absolute;inset:0;width:calc(var(--p)*1%);background:linear-gradient(90deg,var(--accent),var(--accent-2))}
  .rec{position:absolute;top:14px;right:14px;color:#ff4d4d;font-weight:800;text-shadow:0 0 10px #ff4d4d80}
  .rec::before{content:"‚óè ";}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(10,0,20,.78);z-index:10;transition:opacity .25s}
  .overlay.hidden{opacity:0;pointer-events:none}
  .card{background:rgba(255,255,255,.07);padding:28px;border-radius:16px;text-align:center;border:1px solid rgba(255,255,255,.15);max-width:760px}
  .action{border:none;padding:12px 18px;border-radius:12px;font-weight:800;cursor:pointer;background:linear-gradient(180deg,var(--accent),#ff87a0);color:#fff}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(180px,1fr));gap:14px;margin-top:14px}
  .choice{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.15);cursor:pointer}
  .choice img{width:36px;height:36px;image-rendering:pixelated}
  .choice b{font-size:16px}
  .sub{opacity:.8;font-size:12px}
  .holdZone{position:absolute;bottom:18px;left:50%;transform:translateX(-50%);z-index:7;background:rgba(255,255,255,.08);
            border:1px solid rgba(255,255,255,.2);backdrop-filter:blur(6px);padding:10px 16px;border-radius:999px;user-select:none}
  .hint{opacity:.85;font-size:12px;margin-top:6px}
  /* Mobile: prevent highlight/scroll but allow UI taps */
  html, body, #gameRoot, canvas {
    touch-action: none; overscroll-behavior: none;
    user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
  }
  * { -webkit-tap-highlight-color: transparent; }
</style>
</head>
<body>
<div id="gameRoot">
  <canvas id="game" tabindex="0" aria-label="Journey Flight Game"></canvas>

  <div class="hud">
    <div class="pill" id="livesPill">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    <div class="pill">‚úàÔ∏è Dist: <span id="km">10,000</span></div>
    <div class="pill bar" id="progress"></div>
  </div>
  <div class="hud-right">
    <div class="pill btn" id="pauseBtn" title="Pause/Resume">‚è∏Ô∏è</div>
    <div class="pill btn" id="muteBtn" title="Mute/Unmute">üîä</div>
  </div>
  <div class="rec">REC</div>

  <div class="holdZone" id="holdZone">Hold to fly ‚Üë ‚Ä¢ Space / ‚Üë / W also work</div>

  <!-- Choose Journey -->
  <div class="overlay" id="choose">
    <div class="card">
      <h1 style="margin:0 0 10px">Choose Your Journey ‚úàÔ∏èüíú</h1>
      <div class="grid">
        <div class="choice" data-key="aaron"><img src="aaron.png" alt="Aaron" /><div><b>Aaron</b><div class="sub">‚Üí Zarifa</div></div></div>
        <div class="choice" data-key="asef"><img src="asef.png" alt="Asef" /><div><b>Asef</b><div class="sub">‚Üí Wafia</div></div></div>
        <div class="choice" data-key="tajwar"><img src="tajwar.png" alt="Tajwar" /><div><b>Tajwar</b><div class="sub">‚Üí Sehely</div></div></div>
        <div class="choice" data-key="labib"><img src="labib.png" alt="Labib" /><div><b>Labib</b><div class="sub">‚Üí Zarin</div></div></div>
      </div>
      <p class="hint" style="margin-top:12px">Pick someone above first. You‚Äôll get a ‚ÄúFly!‚Äù screen next.</p>
    </div>
  </div>

  <!-- Start (after choosing) -->
  <div class="overlay hidden" id="start">
    <div class="card">
      <h1 style="margin:0 0 8px" id="startTitle">The Flight ‚úàÔ∏è</h1>
      <p style="margin:0">Hold <b>Space / ‚Üë / W</b> or <b>hold screen/trackpad</b> to go up. Dodge meteors, birds, satellites, clouds, and gusts!</p>
      <p class="hint">3 lives. Hit = lose a heart. At 0 ‚Üí <b>Game Over</b>. Reach your goal ‚Üí <b>HUG WIN</b>.</p>
      <button class="action" id="playBtn">üé¨ Fly!</button>
    </div>
  </div>

  <!-- Game Over -->
  <div class="overlay hidden" id="gameover">
    <div class="card">
      <h2 style="margin:0 0 8px">Game Over üíî</h2>
      <p style="margin:0 0 12px">Press <b>Space</b> or <b>Enter</b> ‚Äî or tap/click ‚Äî to try again.</p>
      <button class="action" id="retryBtn">‚Üª Restart</button>
    </div>
  </div>

  <!-- Win (dynamic) -->
  <div class="overlay hidden" id="win">
    <div class="card">
      <h2 style="margin:0 0 10px" id="winTitle">Landed ‚Äî Hug time üíñ</h2>
      <img id="hugImg" src="hug.png" alt="Hug"
        style="image-rendering:pixelated;max-width:320px;width:100%;height:auto;border-radius:8px;border:1px solid rgba(255,255,255,.2);" />
      <div id="hugFallback" style="display:none; margin:0 auto; max-width:320px">
        <svg viewBox="0 0 240 160" width="320" height="214" style="image-rendering:pixelated">
          <rect width="240" height="160" fill="#1a0f2c"/>
          <g fill="#ff7ea0"><rect x="88" y="34" width="8" height="8"/><rect x="144" y="34" width="8" height="8"/>
          <rect x="80" y="42" width="72" height="8"/><rect x="72" y="50" width="88" height="8"/>
          <rect x="72" y="58" width="88" height="8"/><rect x="80" y="66" width="72" height="8"/><rect x="96" y="74" width="40" height="8"/></g>
          <g><rect x="84" y="84" width="24" height="18" fill="#ffd7c8"/><rect x="90" y="90" width="12" height="3" fill="#2a2451"/>
          <rect x="92" y="93" width="2" height="2" fill="#0e0b2b"/><rect x="99" y="93" width="2" height="2" fill="#0e0b2b"/>
          <rect x="84" y="102" width="24" height="16" fill="#3a2b6d"/><rect x="92" y="112" width="16" height="4" fill="#ffd7c8"/></g>
          <g><rect x="128" y="84" width="24" height="18" fill="#ffcfdd"/><rect x="128" y="80" width="24" height="6" fill="#f19ec4"/>
          <rect x="133" y="92" width="3" height="3" fill="#5b2b6d"/><rect x="141" y="92" width="3" height="3" fill="#5b2b6d"/>
          <rect x="128" y="102" width="24" height="16" fill="#8d3c7a"/><rect x="128" y="112" width="16" height="4" fill="#ffcfdd"/></g>
          <rect x="110" y="112" width="20" height="4" fill="#ffd0d6"/>
        </svg>
      </div>
      <p id="winCaption" style="margin:8px 0 14px">They hug and embrace. ü´∂</p>
      <button class="action" id="againBtn">‚Üª Play again</button>
    </div>
  </div>
</div>

<script>
(() => {
  /* ===== Journey roster ===== */
  const roster = {
    aaron: { playerName:'Aaron', playerSprite:'aaron.png', gfName:'Zarifa', gfSprite:'zarifa.png', winImage:'hug.png' },
    asef:  { playerName:'Asef',  playerSprite:'asef.png',  gfName:'Wafia',  gfSprite:'wafia.png',  winImage:'hug_asef.png' },
    tajwar:{ playerName:'Tajwar',playerSprite:'tajwar.png',gfName:'Sehely', gfSprite:'sehely.png', winImage:'hug_tajwar.png' },
    labib: { playerName:'Labib', playerSprite:'labib.png', gfName:'Zarin',  gfSprite:'zarin.png',  winImage:'hug_labib.png' }
  };
  let selected = null; // key in roster

  /* ===== Config ===== */
  const cfg = {
    width:960, height:540,
    gravity:1400, thrust:2400, maxVy:800,
    baseSpeed:300, targetKm:10000,
    livesStart:3,
    spawnBase:1.0, obsSpeedMin:280, obsSpeedMax:420,
    goalRevealKm: 1200
  };

  /* ===== State ===== */
  const state = {
    dpr:Math.min(2,window.devicePixelRatio||1),
    mode:'choose',     // 'choose' | 'start' | 'playing' | 'gameover' | 'win'
    t:0, dist:0, lastSpawn:0,
    lives:cfg.livesStart, muted:false, paused:false
  };

  /* ===== Canvas ===== */
  const root = document.getElementById('gameRoot');
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  function resize(){
    canvas.width = canvas.clientWidth * state.dpr;
    canvas.height = canvas.clientHeight * state.dpr;
    ctx.setTransform(state.dpr,0,0,state.dpr,0,0);
  }
  new ResizeObserver(resize).observe(root); resize();

  /* ===== UI refs ===== */
  const elLives = document.getElementById('livesPill');
  const elKm = document.getElementById('km');
  const elProg = document.getElementById('progress');
  const elChoose = document.getElementById('choose');
  const elStart = document.getElementById('start');
  const elGameOver = document.getElementById('gameover');
  const elWin = document.getElementById('win');
  const startTitle = document.getElementById('startTitle');
  const playBtn = document.getElementById('playBtn');
  const retryBtn = document.getElementById('retryBtn');
  const againBtn = document.getElementById('againBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const muteBtn = document.getElementById('muteBtn');
  const winTitle = document.getElementById('winTitle');
  const winCaption = document.getElementById('winCaption');
  const hugImg = document.getElementById('hugImg');
  const hugFallback = document.getElementById('hugFallback');

  /* ===== Sprites (set on selection) ===== */
  let playerImg=null, playerReady=false;
  let goalImg=null,   goalReady=false;
  function loadSpritesFor(key){
    const conf = roster[key];
    playerImg = new Image(); playerReady=false; playerImg.onload=()=>playerReady=true; playerImg.onerror=()=>playerReady=false; playerImg.src = conf.playerSprite;
    goalImg   = new Image(); goalReady=false;   goalImg.onload=()=>goalReady=true;   goalImg.onerror=()=>goalReady=false;   goalImg.src = conf.gfSprite;
    // Win image
    hugImg.style.display='block'; hugFallback.style.display='none'; hugImg.src = conf.winImage;
  }
  hugImg.addEventListener('error', ()=>{ hugImg.style.display='none'; hugFallback.style.display='block'; });

  function updateHUD(){
    elLives.textContent = '‚ù§Ô∏è'.repeat(state.lives) + 'ü§ç'.repeat(Math.max(0, cfg.livesStart - state.lives));
    elKm.textContent = Math.max(0, cfg.targetKm - Math.floor(state.dist)).toLocaleString();
    elProg.style.setProperty('--p', (state.dist/cfg.targetKm*100).toFixed(2));
  }

  /* ===== Audio (unchanged) ===== */
  let actx, master, sfxGain, musicGain, oscA, oscB, chordTimer=null;
  function initAudio(){
    if(actx) return;
    actx = new (window.AudioContext||window.webkitAudioContext)();
    master = actx.createGain(); master.connect(actx.destination); master.gain.value = state.muted ? 0 : .8;
    sfxGain = actx.createGain(); sfxGain.connect(master); sfxGain.gain.value = .8;
    musicGain = actx.createGain(); musicGain.connect(master); musicGain.gain.value = .10;
    oscA = actx.createOscillator(); oscB = actx.createOscillator();
    const gA = actx.createGain(), gB = actx.createGain(); gA.gain.value=0; gB.gain.value=0;
    oscA.type='sine'; oscB.type='triangle'; oscA.connect(gA).connect(musicGain); oscB.connect(gB).connect(musicGain);
    oscA.start(); oscB.start();
    const chords=[[220,275],[176,330],[293,247],[220,275]]; let i=0;
    function tick(){const [a,b]=chords[i%chords.length]; i++;
      oscA.frequency.setTargetAtTime(a,actx.currentTime,.2);
      oscB.frequency.setTargetAtTime(b,actx.currentTime,.2);
      const off=actx.currentTime+4.5;
      gA.gain.setTargetAtTime(.45,actx.currentTime,.4); gA.gain.setTargetAtTime(0,off,.8);
      gB.gain.setTargetAtTime(.40,actx.currentTime,.4); gB.gain.setTargetAtTime(0,off,.8);
    }
    tick(); chordTimer=setInterval(tick,6000);
  }
  function sfx(freq=900,dur=.08,type='square',gain=.25){ if(!actx) return;
    const o=actx.createOscillator(), g=actx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(sfxGain); o.start();
    g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime+dur); o.stop(actx.currentTime+dur);
  }
  function toggleMute(){ state.muted=!state.muted; muteBtn.textContent=state.muted?'üîá':'üîä'; if(master) master.gain.value=state.muted?0:.8; }

  /* ===== Input ===== */
  let pressing=false;
  function isFlyKey(e){const c=e.code,k=e.key;return c==="Space"||c==="Spacebar"||c==="ArrowUp"||c==="KeyW"||k===" "||k==="w"||k==="W";}
  function isRestartKey(e){const c=e.code,k=e.key;return c==="Space"||c==="Enter"||k===" "||k==="Enter";}
  function down(e){
    if(state.mode==='playing'){
      if(isFlyKey(e)){ pressing=true; e.preventDefault(); }
      if(e.code==="KeyP"){ togglePause(); }
      if(e.code==="KeyM"){ toggleMute(); }
    }else if(state.mode==='start'){
      if(isRestartKey(e)){ e.preventDefault(); startGame(); }
    }
  }
  function up(e){ if(isFlyKey(e)){ pressing=false; e.preventDefault(); } }
  window.addEventListener('keydown',down,true);
  window.addEventListener('keyup',up,true);
  window.addEventListener('keypress',e=>{ if(isFlyKey(e)||isRestartKey(e)) e.preventDefault(); },true);

  // Touch: block page gestures but allow UI
  ['touchstart','touchmove','touchend','touchcancel'].forEach(type => {
    root.addEventListener(type, (e) => {
      const target = e.target;
      if (target.closest('.btn, button, .action, #start, #gameover, #win, #choose')) return;
      e.preventDefault();
      if (state.mode === 'playing') {
        if (type === 'touchstart') pressing = true;
        if (type === 'touchend' || type === 'touchcancel') pressing = false;
      } else if (state.mode==='start') {
        if (type === 'touchstart') startGame();
      }
    }, { passive: false });
  });
  root.addEventListener('wheel', (e) => { e.preventDefault(); }, { passive: false });

  // Buttons
  playBtn.onclick=startGame;
  retryBtn.onclick=()=>{ state.mode='start'; elGameOver.classList.add('hidden'); elStart.classList.remove('hidden'); };
  againBtn.onclick=()=>{ state.mode='start'; elWin.classList.add('hidden'); elStart.classList.remove('hidden'); };
  pauseBtn.onclick=togglePause;
  muteBtn.onclick=toggleMute;

  // Choose journey (direct listeners)
  function chooseJourney(key){
    selected = key;
    loadSpritesFor(key);
    const conf = roster[key];
    startTitle.textContent = `The Flight to ${conf.gfName} ‚úàÔ∏èüíú`;
    winTitle.textContent   = `Landed ‚Äî ${conf.playerName} & ${conf.gfName}`;
    winCaption.textContent = `${conf.playerName} and ${conf.gfName} hug and embrace. ü´∂`;
    elChoose.classList.add('hidden');
    elStart.classList.remove('hidden');
    state.mode='start';
  }
  document.querySelectorAll('#choose .choice').forEach(card => {
    card.setAttribute('tabindex','0');
    card.setAttribute('role','button');
    card.addEventListener('click', () => chooseJourney(card.dataset.key));
    card.addEventListener('touchstart', () => chooseJourney(card.dataset.key), {passive:true});
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); chooseJourney(card.dataset.key); }
    });
  });

  /* ===== Parallax Stars (single definition) ===== */
  const stars={far:makeStars(40,.15), mid:makeStars(28,.35), near:makeStars(20,.65)}; let scroll=0;
  function makeStars(n,tw){const a=[]; for(let i=0;i<n;i++) a.push({x:Math.random()*cfg.width,y:Math.random()*cfg.height,s:Math.random()*2+1,a:0.6+Math.random()*0.4,tw:tw*(0.5+Math.random())}); return a;}
  function drawStars(layer,mul,color){ctx.save(); ctx.fillStyle=color; for(const st of layer){const x=(st.x-(scroll*mul)%(cfg.width+50)); const xx=x<-10?x+cfg.width+50:x; const tw=0.85+Math.sin(state.t*2+st.x*0.01)*0.15*st.tw; ctx.globalAlpha=st.a*tw; ctx.fillRect(xx,st.y,st.s,st.s);} ctx.restore(); ctx.globalAlpha=1;}

  /* ===== Entities ===== */
  class Plane{
    constructor(){ this.x=160; this.y=cfg.height*0.6; this.vy=0; this.w=74; this.h=30; this.blink=0; }
    update(dt){
      const a=cfg.gravity - (pressing?cfg.thrust:0);
      this.vy+=a*dt; this.vy=Math.max(-cfg.maxVy,Math.min(cfg.maxVy,this.vy));
      this.y+=this.vy*dt;
      if(this.y<30){this.y=30; this.vy=0;}
      if(this.y>cfg.height-30){this.y=cfg.height-30; this.vy=0;}
      if(this.blink>0)this.blink-=dt;
    }
    rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h}; }
    draw(ctx){
      ctx.save(); ctx.translate(this.x,this.y);
      ctx.globalAlpha=(this.blink>0 && Math.floor(this.blink*20)%2===0)?0.35:1;

      // ship
      ctx.fillStyle='#e5e2ff'; ctx.fillRect(-this.w/2,-this.h/2,this.w,this.h);
      ctx.fillStyle='#b084ff'; ctx.fillRect(-14,-this.h/2-10,52,12);
      ctx.fillStyle='#ff7da0'; ctx.fillRect(this.w/2-8,-this.h/2,8,this.h);
      ctx.globalAlpha=.5; ctx.fillStyle='#ff7da0'; ctx.fillRect(-this.w/2-6,-2,4,4); ctx.globalAlpha=1;

      // selected player sprite on top
      const w=36,h=36,x=-w/2,y=-this.h/2-h+6;
      if(playerReady){
        const sm=ctx.imageSmoothingEnabled; ctx.imageSmoothingEnabled=false;
        ctx.drawImage(playerImg,x,y,w,h); ctx.imageSmoothingEnabled=sm;
      } else {
        ctx.fillStyle='#ffd7c8'; ctx.fillRect(x+10,y+12,16,12);
        ctx.fillStyle='#0e0b2b'; ctx.fillRect(x+12,y+16,2,2); ctx.fillRect(x+20,y+16,2,2);
        ctx.fillStyle='#3a2b6d'; ctx.fillRect(x+8,y+24,20,10);
        ctx.fillStyle='#2a2451'; ctx.fillRect(x+6,y+12,20,2);
      }
      ctx.restore();
    }
    takeHit(){ if(state.lives>0){ state.lives--; updateHUD(); this.blink=.6; sfx(180,.16,'sawtooth',.35); if(state.lives<=0) gameOver(); } }
  }

  class Obstacle{
    constructor(kind,x,y,speed){
      this.kind=kind; this.x=x; this.y=y; this.speed=speed; this.alive=true; this.t=0;
      this.w= kind==='bird'?42 : kind==='cloud'?78 : kind==='gust'?36 : kind==='meteor'?32 : 40;
      this.h= kind==='bird'?26 : kind==='cloud'?44 : kind==='gust'?36 : kind==='meteor'?28 : 26;
    }
    rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h:this.h}; }
    update(dt){
      this.t+=dt; this.x-=this.speed*dt; if(this.x<-120) this.alive=false;
      if(this.kind==='meteor') this.y+=Math.sin(this.t*8)*0.6;
      if(this.kind==='satellite') this.y+=Math.sin(this.t*5)*0.4;
    }
    draw(ctx){
      ctx.save(); ctx.translate(this.x,this.y);
      if(this.kind==='bird'){
        ctx.fillStyle='#ffdede'; rrect(ctx,-18,-9,36,18,8); ctx.fill();
        ctx.fillStyle='#ff7da0'; rrect(ctx,-10,-3,18,6,3); ctx.fill();
        ctx.fillStyle='#2a2451'; ctx.fillRect(8,-2,3,3);
        ctx.fillStyle='#ffc23e'; ctx.beginPath(); ctx.moveTo(18,-2); ctx.lineTo(28,0); ctx.lineTo(18,2); ctx.fill();
      } else if(this.kind==='cloud'){
        ctx.fillStyle='rgba(255,255,255,.85)'; cloud(ctx,0,0,this.w,this.h); ctx.fill();
      } else if(this.kind==='gust'){
        ctx.strokeStyle='#b3a6ff'; ctx.lineWidth=2.5; ctx.beginPath();
        for(let i=-18;i<=18;i++){ const yy=Math.sin((i/6)+this.t*6)*6; if(i===-18) ctx.moveTo(i,yy); else ctx.lineTo(i,yy); }
        ctx.stroke();
      } else if(this.kind==='meteor'){
        ctx.fillStyle='#ffa07a'; rrect(ctx,-14,-10,28,20,6); ctx.fill();
        ctx.globalAlpha=.6; ctx.fillStyle='#ff6b6b'; ctx.beginPath(); ctx.ellipse(-20,0,14,6,0,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
        ctx.fillStyle='#5a2a2a'; ctx.fillRect(-6,-4,4,4); ctx.fillRect(2,2,3,3);
      } else if(this.kind==='satellite'){
        ctx.fillStyle='#d0d7ff'; rrect(ctx,-8,-6,16,12,2); ctx.fill();
        ctx.fillStyle='#7aa0ff'; ctx.fillRect(-26,-4,16,8); ctx.fillRect(10,-4,16,8);
        ctx.fillStyle='#2a2451'; ctx.fillRect(-1,-10,2,20);
      }
      ctx.restore();
    }
  }

  class Goal{
    constructor(){ this.x=cfg.width+140; this.y=cfg.height*0.55; this.w=40; this.h=48; this.speed=320; this.active=true; }
    rect(){ return {x:this.x-this.w/2,y:this.y-this.h/2,w:this.w,h	this.h}; }
    update(dt){ this.x -= this.speed*dt; if(this.x<-120) this.active=false; }
    draw(ctx){
      if(!goalReady) return;
      const sm=ctx.imageSmoothingEnabled; ctx.imageSmoothingEnabled=false;
      ctx.drawImage(goalImg, this.x-this.w/2, this.y-this.h, this.w, this.h);
      ctx.imageSmoothingEnabled=sm;
    }
  }

  function rrect(ctx,x,y,w,h,r){const rr=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+rr,y);ctx.arcTo(x+w,y,x+w,y+h,rr);ctx.arcTo(x+w,y+h,x,y+h,rr);ctx.arcTo(x,y+h,x,y,rr);ctx.arcTo(x,y,x+w,y,rr);ctx.closePath();}
  function cloud(ctx,x,y,w,h){ctx.beginPath();ctx.ellipse(x-w*.15,y,w*.35,h*.46,0,0,Math.PI*2);ctx.ellipse(x+w*.05,y-h*.06,w*.42,h*.52,0,0,Math.PI*2);ctx.ellipse(x+w*.3,y,w*.48,h*.5,0,0,Math.PI*2);}
  function overlap(a,b){return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;}

  const plane=new Plane();
  const obstacles=[];
  let goal=null;

  function spawnObstacle(){
    const r=Math.random();
    const kind = r<.35?'bird' : r<.6?'cloud' : r<.75?'gust' : r<.9?'meteor' : 'satellite';
    const y=60+Math.random()*(cfg.height-120);
    const speed=cfg.obsSpeedMin+Math.random()*(cfg.obsSpeedMax-cfg.obsSpeedMin);
    obstacles.push(new Obstacle(kind,cfg.width+120,y,speed));
  }

  /* ===== Loop ===== */
  let last=performance.now(); let scroll=0;
  function loop(now){
    const dt=Math.min(0.033,(now-last)/1000); last=now;
    if(state.mode!=='playing' || state.paused){ requestAnimationFrame(loop); return; }

    state.t+=dt; state.lastSpawn+=dt; scroll+=(cfg.baseSpeed*dt);

    // progress & spawns
    state.dist=Math.min(cfg.targetKm, state.dist + (cfg.baseSpeed/3.5)*dt);
    const interval=Math.max(0.6, cfg.spawnBase - (state.dist/cfg.targetKm)*0.4);
    if(state.lastSpawn>interval){ spawnObstacle(); state.lastSpawn=0; }

    // reveal goal near finish
    if(!goal && (cfg.targetKm - state.dist) <= cfg.goalRevealKm){ goal=new Goal(); }

    // updates
    plane.update(dt);
    for(const ob of obstacles) ob.update(dt);
    if(goal) goal.update(dt);

    // collisions
    const pr=plane.rect();
    for(const ob of obstacles){
      if(!ob.alive) continue;
      if(overlap(pr, ob.rect())){ ob.alive=false; plane.takeHit(); break; }
    }
    if(goal && goal.active && overlap(pr, goal.rect())){ return win(); }

    // cull
    for(let i=obstacles.length-1;i>=0;i--) if(!obstacles[i].alive) obstacles.splice(i,1);
    if(goal && !goal.active) goal=null;

    // DRAW
    ctx.clearRect(0,0,cfg.width,cfg.height);
    drawStars(stars.far,0.2,'#d9d4ff'); drawStars(stars.mid,0.45,'#fff0ff'); drawStars(stars.near,0.8,'#ffffff');
    const g=ctx.createLinearGradient(0,0,0,cfg.height); g.addColorStop(0,'rgba(255,255,255,0.02)'); g.addColorStop(1,'rgba(255,120,160,0.04)'); ctx.fillStyle=g; ctx.fillRect(0,0,cfg.width,cfg.height);
    plane.draw(ctx);
    if(goal) goal.draw(ctx);
    for(const ob of obstacles) ob.draw(ctx);
    updateHUD();
    if(state.dist>=cfg.targetKm) return win();

    requestAnimationFrame(loop);
  }

  /* ===== States ===== */
  function startGame(){
    if(!selected){ elChoose.classList.remove('hidden'); state.mode='choose'; return; }
    state.mode='playing'; state.paused=false; state.t=0; state.dist=0; state.lastSpawn=0; state.lives=cfg.livesStart;
    obstacles.length=0; goal=null; pressing=false; updateHUD();
    elStart.classList.add('hidden'); elGameOver.classList.add('hidden'); elWin.classList.add('hidden');
    window.focus(); canvas.focus(); initAudio();
    requestAnimationFrame(n=>{ last=n; requestAnimationFrame(loop); });
  }
  function gameOver(){ state.mode='gameover'; elGameOver.classList.remove('hidden'); }
  function win(){ state.mode='win'; elWin.classList.remove('hidden'); sfx(1200,.12,'triangle',.35); sfx(1500,.18,'square',.25); }
  function togglePause(){ if(state.mode!=='playing') return; state.paused=!state.paused; pauseBtn.textContent=state.paused?'‚ñ∂Ô∏è':'‚è∏Ô∏è'; }

  // Buttons
  playBtn.onclick=startGame;
  retryBtn.onclick=()=>{ state.mode='start'; elGameOver.classList.add('hidden'); elStart.classList.remove('hidden'); };
  againBtn.onclick=()=>{ state.mode='start'; elWin.classList.add('hidden'); elStart.classList.remove('hidden'); };
  pauseBtn.onclick=togglePause;
  muteBtn.onclick=toggleMute;

  // Choose journey (attach once)
  document.querySelectorAll('#choose .choice').forEach(card => {
    card.setAttribute('tabindex','0');
    card.setAttribute('role','button');
    card.addEventListener('click', () => chooseJourney(card.dataset.key));
    card.addEventListener('touchstart', () => chooseJourney(card.dataset.key), {passive:true});
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); chooseJourney(card.dataset.key); }
    });
  });
  function chooseJourney(key){
    selected = key;
    loadSpritesFor(key);
    const conf = roster[key];
    startTitle.textContent = `The Flight to ${conf.gfName} ‚úàÔ∏èüíú`;
    winTitle.textContent   = `Landed ‚Äî ${conf.playerName} & ${conf.gfName}`;
    winCaption.textContent = `${conf.playerName} and ${conf.gfName} hug and embrace. ü´∂`;
    elChoose.classList.add('hidden');
    elStart.classList.remove('hidden');
    state.mode='start';
  }

  updateHUD();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
